version: '3.8'

services:
    nginx:
        image: nginx:latest
        container_name: nginx
        volumes:
            - "./{{ nginx_base_dir }}:/usr/share/nginx/html"
        restart: unless-stopped
        networks:
            - traefik
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.nginx.rule=Host(`salamix.home.bensemer.name`)"
            - "traefik.http.routers.nginx.entrypoints=web"
            - "traefik.http.routers.nginx-https.rule=Host(`salamix.home.bensemer.name`)"
            - "traefik.http.routers.nginx-https.tls=true"
            - "traefik.http.routers.nginx-https.tls.certresolver=myresolver"
            - "traefik.http.routers.nginx-https.entrypoints=websecure"

    traefik:
        image: "traefik:latest"
        container_name: traefik
        ports:
            - "80:80"
            - "443:443"
            - "8080:8080"
        volumes:
            - "/var/run/docker.sock:/var/run/docker.sock:ro"
            - "./{{ traefik_base_dir }}/letsencrypt:/letsencrypt"
            - "./{{ traefik_base_dir }}/config/config.yml:/etc/traefik/config.yml:ro"
            - "./{{ traefik_base_dir }}/config/traefik.yml:/etc/traefik/traefik.yml:ro"
        environment:
            - HETZNER_API_KEY=${HETZNER_API_KEY}
        networks:
            - traefik            
        restart: always

    homepage:
        image: ghcr.io/gethomepage/homepage:latest
        container_name: homepage
        volumes:
            - ./homepage:/app/config
            - /var/run/docker.sock:/var/run/docker.sock
        networks:
            - traefik
        restart: unless-stopped
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.homepage.rule=Host(`homepage.home.bensemer.name`)"
            - "traefik.http.routers.homepage.tls=true"
            - "traefik.http.routers.homepage.tls.certresolver=myresolver"
            - "traefik.http.routers.homepage.entrypoints=websecure"

        environment:
            HOMEPAGE_ALLOWED_HOSTS: homepage.home.bensemer.name
            
    forgejo:
        image: codeberg.org/forgejo/forgejo:11 
        container_name: forgejo
        environment:
            - USER_UID=1000
            - USER_GID=1000
        restart: always
        networks:
            - traefik
        volumes:
            - ./forgejo:/data
            - /etc/timezone:/etc/timezone:ro
            - /etc/localtime:/etc/localtime:ro
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.forgejo.rule=Host(`forgejo.home.bensemer.name`)"
            - "traefik.http.routers.forgejo.entrypoints=websecure"
            - "traefik.http.routers.forgejo.tls=true"
            - "traefik.http.routers.forgejo.tls.certresolver=myresolver"
            - "traefik.http.services.forgejo.loadbalancer.server.port=3000"

#    newt:
#        image: fosrl/newt
#        container_name: newt
#        restart: unless-stopped
#        environment:
#            - PANGOLIN_ENDPOINT=https://pangolin.bensemer.name
#            - NEWT_ID=7ep6qjwfpknsn8l
#            - NEWT_SECRET=xsasel8jvuxozcsyk9oninhzwzz1mi7i41aq6kiqenulfcri
#        networks:
#        - traefik

networks:
  backend:
    external: true




networks:
    traefik:
        name: traefik